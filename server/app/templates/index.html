<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NetGuard.AI MVP</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 10px; }
    .muted { color: #666; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    th { background: #f5f5f5; text-align: left; }
    .pill { padding: 2px 8px; border-radius: 999px; font-weight: 600; font-size: 12px; display: inline-block; }
    .ok { background: #e7f7ea; color: #136b2a; }
    .bad { background: #fde8e8; color: #9b1c1c; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
    @media (min-width: 1000px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 14px; }
    .top { display:flex; justify-content:space-between; align-items:flex-end; gap: 12px; }
    code { background: #f7f7f7; padding: 2px 4px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="top">
    <div>
      <h1>NetGuard.AI — MVP</h1>
      <div class="muted">FastAPI • Isolation Forest • только агрегированные метрики (без payload)</div>
    </div>
    <div class="muted">UTC: {{ now.isoformat() }}</div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card">
      <h2 style="margin:0 0 10px;">Алёрты (последние 20)</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Время</th><th>Хост</th><th>Интерфейс</th><th>Score</th><th>Порог</th><th>Причина</th>
          </tr>
        </thead>
        <tbody>
          {% for a in alerts %}
          <tr>
            <td>{{ a.id }}</td>
            <td>{{ a.ts.isoformat() }}</td>
            <td>{{ a.host }}</td>
            <td>{{ a.iface }}</td>
            <td>{{ "%.4f"|format(a.score) }}</td>
            <td>{{ "%.4f"|format(a.threshold) }}</td>
            <td>{{ a.reason }}</td>
          </tr>
          {% endfor %}
          {% if alerts|length == 0 %}
          <tr><td colspan="7" class="muted">Пока нет алёртов. Запусти агент или режим <code>--simulate</code>.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Метрики (последние 50)</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Время</th><th>Хост</th><th>bps_in</th><th>bps_out</th><th>pps_in</th><th>pps_out</th><th>Score</th><th>Статус</th>
          </tr>
        </thead>
        <tbody>
          {% for m in metrics %}
          <tr>
            <td>{{ m.id }}</td>
            <td>{{ m.ts.isoformat() }}</td>
            <td>{{ m.host }} / {{ m.iface }}</td>
            <td>{{ "%.0f"|format(m.bps_in) }}</td>
            <td>{{ "%.0f"|format(m.bps_out) }}</td>
            <td>{{ "%.0f"|format(m.pps_in) }}</td>
            <td>{{ "%.0f"|format(m.pps_out) }}</td>
            <td>{{ "%.4f"|format(m.anomaly_score) }}</td>
            <td>
              {% if m.is_anomaly == 2 %}
                <span class="pill bad">ручная аномалия</span>
              {% elif m.is_anomaly %}
                <span class="pill bad">аномалия</span>
              {% else %}
                <span class="pill ok">норма</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% if metrics|length == 0 %}
          <tr><td colspan="9" class="muted">Пока нет данных. Агент ещё не отправлял метрики.</td></tr>
          {% endif %}
        </tbody>
      </table>
      <div class="muted" style="margin-top:10px;">
        API: <code>/api/metrics</code> и <code>/api/alerts</code>
      </div>
    </div>
  </div>
</body>
</html>
